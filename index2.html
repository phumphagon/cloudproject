<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RaPunSale - ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
  <link rel="stylesheet" href="CSS/index2.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
 
  </style>
</head>
<body>

  <!-- Top Bar -->
  <header class="top-bar">
    <div class="lang">üåê TH | ‡πÑ‡∏ó‡∏¢</div>
    <div class="user-info" id="userInfo"></div>
  </header>

  <!-- Main Product Section -->
  <section class="product-detail">
    <div class="product-image">
      <img src="image/default.png" alt="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ..." />
    </div>

    <div class="product-info">
      <h2 class="product-title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h2>
      <p class="product-desc">-</p>
      <p class="product-price">- <span>‡∏ö‡∏≤‡∏ó</span></p>
      <p class="product-stock"><i class="fa fa-spinner"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î</p>
      <p id="product-quantity"><i class="fa fa-cubes"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á: <span>...</span></p>

      <div class="product-action">
        <div class="quantity-selector">
          <input type="number" value="1" min="-100000" />
        </div>
        <button class="update-stock" onclick="updateStock()">Update Stock</button>
      </div>

      <button class="download-info" onclick="downloadSpec()">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      <button class="update-stock" onclick="window.location.href='index.html'">
        <i class="fa fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
      </button>
    </div>
  </section>

  <script>
    const apiUrl = "https://dg4t1cf76l.execute-api.us-east-1.amazonaws.com/get-products";
    let productDocUrl = "";

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö login ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    const name = localStorage.getItem("name");
    const role = localStorage.getItem("role");

    if (!name || !role) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
      window.location.href = "login.html";
    } else {
      document.getElementById("userInfo").innerHTML =
        `<i class="fa fa-user-circle"></i> ${name} (${role})`;
    }

    function getProductIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("productId");
    }

    function fetchProductDetail() {
      const productId = getProductIdFromURL();
      if (!productId) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö productId ‡πÉ‡∏ô URL");
        return;
      }

      fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
          const product = data.find(p => p.productId === productId);
          if (!product) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å API");
            return;
          }

          productDocUrl = product.doc || "";
          document.querySelector(".product-title").textContent = product.name;
          document.querySelector(".product-desc").textContent = product.des || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
          document.querySelector(".product-price").innerHTML = `${product.price} <span>‡∏ö‡∏≤‡∏ó</span>`;

          const stockEl = document.querySelector(".product-stock");
          if (product.stock <= 0) {
            stockEl.innerHTML = `<i class="fa fa-times" style="color:red"></i> <span style="color:red">‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å</span>`;
          } else if (product.stock <= 3) {
            stockEl.innerHTML = `<i class="fa fa-exclamation-triangle" style="color:red"></i> <span style="color:red">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å</span>`;
          } else {
            stockEl.innerHTML = `<i class="fa fa-check" style="color:green"></i> <span style="color:green">‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å</span>`;
          }

          document.querySelector("#product-quantity span").textContent = product.stock;

          const img = document.querySelector(".product-image img");
          img.src = `${product.picture || product.productId + '.png'}`;
          img.alt = product.name;
        })
        .catch(err => {
          console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á");
        });
    }

    function updateStock() {
  const productId = getProductIdFromURL();
  const input = document.querySelector(".quantity-selector input");
  const deltaStock = parseInt(input.value);

  if (!productId || isNaN(deltaStock) || deltaStock === 0) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î (¬±)");
    return;
  }

  // ‚úÖ ‡∏î‡∏∂‡∏á stock ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
  fetch(apiUrl)
    .then(res => res.json())
    .then(data => {
      const product = data.find(p => p.productId === productId);
      if (!product) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
        return;
      }

      const currentStock = parseInt(product.stock);
      const newStock = currentStock + deltaStock;

      if (newStock < 0) {
        alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ: stock ‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏•‡∏ö (${newStock})`);
        return;
      }

      // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ newStock ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      fetch("https://dg4t1cf76l.execute-api.us-east-1.amazonaws.com/get-products", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId, stock: deltaStock })
      })
        .then(res => res.json())
        .then(() => {
          alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï stock ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
          fetchProductDetail();
        })
        .catch(err => {
          console.error("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
        });
    })
    .catch(err => {
      console.error("‡∏î‡∏∂‡∏á stock ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
    });
}


    function downloadSpec() {
      if (!productDocUrl) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");
        return;
      }
      window.open(productDocUrl, "_blank");
    }

    document.addEventListener("DOMContentLoaded", fetchProductDetail);
  </script>

</body>
</html>
